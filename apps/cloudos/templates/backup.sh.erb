#!/bin/bash

CHEF_HOME=<%=Chef::Recipe::Base.chef_user_home%>/chef

# see if there's an existing backup runlist ... if so, delete it
if [ -f "${CHEF_HOME}/backup.json" ] ; then
	rm "${CHEF_HOME}/backup.json"
fi

echo '{ "run_list": [' > ${CHEF_HOME}/backup.json

# get the list of installed, backup-able apps
apps=( `find ${CHEF_HOME} -type f -name 'backup.rb' | awk -F/ '{print $3}'` )

for app in ${apps[@]}
do
	echo "\"recipe[${app}::backup]\","
done

sed -i '$s/,$//' ${CHEF_HOME}/backup.json
echo '} ]' >> ${CHEF_HOME}/backup.json

cd ${CHEF_HOME}
chef-solo -c solo.rb -j backup.json