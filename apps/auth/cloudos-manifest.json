{
    "name": "auth",
    "version": "0.1.0",
    "style": "system",
    "level": "system",
    "publisher": {
        "maintainer": "Jonathan Cobb",
        "maintainer_email": "jonathan@cloudstead.io",
        "license": "https://www.gnu.org/licenses/agpl-3.0.txt",
        "code_copyright": "Copyright 2014 Cloudstead, Inc.",
        "packaging_copyright": "Copyright 2014 Cloudstead, Inc."
    },

    "config": [ {
        "name": "init",
        "items": [ "ldap.server", "ldap.domain", "ldap.realm",
                   "ldap.parentCN", "ldap.adminDN", "ldap.people", "ldap.group" ]
    } ],

    "pre_package": [ { "exec": "@files/pre_package.sh", "unless": "/etc/krb5kdc/setup.marker" } ],

    "packages": [ "haveged", "slapd", "ldap-utils",
                  "krb5-kdc", "krb5-kdc-ldap", "krb5-admin-server",
                  "libkrb5-dev", "ldapscripts" ],

    "post_package": [ {
        "exec": "@files/post_package.sh @files/schema_convert.conf @ldap(admin_dn)",
        "env": { "LDAP_PASSWORD": "@ldap(password)" },
        "unless": "/etc/krb5kdc/setup.marker"
    } ],

    "passwords": [ "kerberos", "ldap" ],

    "templates": {
        "/etc/krb5.conf": "_",
        "/etc/krb5kdc/kadm5.acl": "_",
        "/etc/ldap/ldap.conf": "_",
        "@files/post_install.sh": "_"
    },

    "perms": {
        "/etc/krb5.conf": { "perms": "644" },
        "/etc/krb5kdc/kadm5.acl": { "perms": "644" },
        "/etc/ldap/ldap.conf": { "perms": "644" },
        "@files/post_install.sh": { "perms": "700" }
    },

    "post_install": [ {
        "exec": "@files/post_install.sh",
        "env": { "LDAP_PASSWORD": "@ldap(password)", "KRB_PASSWORD": "@password[kerberos]" },
        "unless": "/etc/krb5kdc/setup.marker"
    } ],

    "services": [
        { "name": "slapd",             "pattern": "/usr/sbin/slapd",   "ports": [ "389", "31113" ] },
        { "name": "krb5-kdc",          "pattern": "/usr/sbin/krb5kdc" },
        { "name": "krb5-admin-server", "pattern": "/usr/sbin/kadmind", "ports": [ "464", "749" ] }
    ],

    "backup": {
        "files": [ "/etc/krb*" ],
        "pre": [ { "exec": "@files/pre_backup.sh @backup_dir" } ]
    },

    "restore": {
        "pre": [ {"exec": "@files/pre_restore.sh @backup_dir"} ]
    }

}