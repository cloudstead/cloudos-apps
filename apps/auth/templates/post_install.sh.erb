#!/bin/bash

<% ldap = @app[:auth][:ldap] %>

if [ -f /etc/krb5kdc/setup.marker ] ; then
  echo "$(date): marker file exists, skipping $0 $@" 2>&1 | tee -a /tmp/kerb.log

else

echo "$(date): starting $0 $@" >> /tmp/kerb.log
echo "$(date): contents of /etc/krb5.conf: $(cat /etc/krb5.conf)" >> /tmp/kerb.log

parent_domain="<%=@app[:domain]%>"
realm="<%=ldap.realm%>"
adminDN="<%=ldap.admin_dn%>"
baseDN="<%=ldap.base_dn%>"
parentCN="<%=ldap.parent_cn%>"
people="<%=ldap.user_class%>"
groups="<%=ldap.group_class%>"

krb_master_password="${KRB_PASSWORD?no KRB_PASSWORD found in env}"
ldap_master_password="${LDAP_PASSWORD?no LDAP_PASSWORD found in env}"

ldap_domain_string="<%=ldap.ldap_domain%>"

echo "${krb_master_password}
${krb_master_password}" | kdb5_ldap_util -D ${adminDN} create -subtrees ${baseDN} \
  -r ${realm} -s -w ${ldap_master_password} -H ldapi:///

echo "${ldap_master_password}
${ldap_master_password}
${ldap_master_password}" | kdb5_ldap_util -D ${adminDN} stashsrvpw \
  -f /etc/krb5kdc/service.keyfile ${adminDN}

# force krb_master_password (for some reason it doesn't seem to get set correctly by now)
echo "change_password kadmin/admin
${krb_master_password}
${krb_master_password}" | kadmin.local

# stash ldap password for ldapscripts
echo -n "${ldap_master_password}" > /etc/ldapscripts/ldapscripts.passwd
chmod 400 /etc/ldapscripts/ldapscripts.passwd

# create the People and Group OU's
echo "dn: <%=ldap.user_dn%>
objectClass: <%=ldap.org_unit_class%>
ou: <%=ldap.users%>

dn: <%=ldap.group_dn%>
objectClass: <%=ldap.org_unit_class%>
ou: <%=ldap.groups%>" | ldapadd -x -H ldapi:/// -D ${adminDN} -w ${ldap_master_password}

# touch marker file, this script should not run on future installs
touch /etc/krb5kdc/setup.marker

echo "$(date): completed $0 $@" >> /tmp/kerb.log

fi